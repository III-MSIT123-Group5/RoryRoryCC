@model BusinessSystemMVC_Admin_page_.Models.CommentQuestion

@{
    //Layout = null;

    var commentContentItems = ViewBag.CommentContentItems as List<GroupedSelectListItem>;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>建立意見調查</title>
    <style>

        h2, label, span, optgroup, select, th {
            font-family: 'NotoSansCJKtc-Bold';
        }

        /*th {
            background-color: #77C9D4;
            color: white;
        }*/

        td {
            font-family: 'NotoSansCJKtc-Light';
        }

        .multiselect-selected-text {
            color: orange;
        }
    </style>



</head>
<body>
    @using (Html.BeginForm())
    {
        @Html.AntiForgeryToken()

        @*@Html.HiddenFor(model => model.CommentMainID)
        @Html.HiddenFor(model => model.EmployeeID)
        @Html.HiddenFor(model => model.SendTime)*@

        <h2>建立意見調查</h2>
        <br />
        <div>
            <div class="form-group">
                @Html.LabelFor(model => model.CommentContentID, "意見類型", htmlAttributes: new { @class = "control-label col-md-2 label" })
                <div class="col-md-10">
                    @Html.DropDownGroupList("CommentContent", commentContentItems, "請選擇意見類型", htmlAttributes: new { @class = "label", style = "Width:400px;height:40px" })

                </div>
            </div>

            @*<div class="form-group">
                    @Html.LabelFor(model => model.CommentName, "意見名稱", htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.EditorFor(model => model.CommentName, new { htmlAttributes = new { @class = "form-control", style = "Width:400px" } })
                        @Html.ValidationMessageFor(model => model.CommentName, "", new { @class = "text-danger" })
                    </div>
                </div>*@

            @*<div class="form-group">
                    @Html.LabelFor(model => model.Employee.Department, "發送部門", htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        <select id="mul" multiple="multiple" style="display:none;">
                            <option value="multiselect-all">select all</option>
                        </select>
                    </div>
                </div>*@

            <div class="form-group">
                @Html.LabelFor(model => model.CommentContent.CommentQuestions, "調查題目", htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    <table class="table table-bordered" id="tableQ" style="width:600px">
                        @*<tr>
                            <th>@Html.CheckBox("CheckAll", false, new { id = "select_all" })</th>*@

                        @*@for (int i = 0; i < Model.additionalCustomerInfoListView.Count; i++)
                            {
                            <tr>
                                <td>@Html.CheckBoxFor(model => model.additionalCustomerInfoListView[i].IsSelected, new { id = "someDivId" })</td>
                            </tr>
                            }*@
                    </table>
                </div>
            </div>
            <div style="width:92%">
                <table id="Ctable" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>調查內容</th>
                            <th>選項編號</th>
                            <th>選項</th>
                            <th>編輯/刪除</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

            </div>

            @*<select class="multiselect" multiple="multiple"></select>*@


            @*<div class="form-horizontal">
                <h4>CommentMain</h4>
                <hr />
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                <div class="form-group">
                    @Html.LabelFor(model => model.CommentMainID, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.EditorFor(model => model.CommentMainID, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.CommentMainID, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.CommentName, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.EditorFor(model => model.CommentName, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.CommentName, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.EmployeeID, "EmployeeID", htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.DropDownList("EmployeeID", null, htmlAttributes: new { @class = "form-control" })
                        @Html.ValidationMessageFor(model => model.EmployeeID, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.SendTime, htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.EditorFor(model => model.SendTime, new { htmlAttributes = new { @class = "form-control" } })
                        @Html.ValidationMessageFor(model => model.SendTime, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.CommentContentID, "CommentContentID", htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.DropDownList("CommentContentID", null, htmlAttributes: new { @class = "form-control" })
                        @Html.ValidationMessageFor(model => model.CommentContentID, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.LabelFor(model => model.ActivityMainID, "ActivityMainID", htmlAttributes: new { @class = "control-label col-md-2" })
                    <div class="col-md-10">
                        @Html.DropDownList("ActivityMainID", null, htmlAttributes: new { @class = "form-control" })
                        @Html.ValidationMessageFor(model => model.ActivityMainID, "", new { @class = "text-danger" })
                    </div>
                </div>*@

            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <input type="reset" value="清除" class="btn btn-warning" style="margin-right:10px" />
                    <input type="submit" value="送出貼文" class="btn btn-success" style="margin-right:10px" />
                </div>
            </div>
        </div>
    }

    <div>
        @Html.ActionLink("回上一頁", "Index")
    </div>

    @*<link href="//cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />*@
    <link href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="~/Content/bootstrap-multiselect.css" type="text/css">

    @section scripts{

        <script src="//cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
        <script src="/Scripts/moment.js"></script>
        <script src="~/Scripts/bootstrap-multiselect.js"></script>

        <script>
            var Popup, dataTable;

            $(document).ready(function () {

                dataTable = $('#Ctable').DataTable({
                    "ajax": {
                        url: '@Url.Action("ReadyLoadCommentContent", "CommentQuestions")',
                        method: 'GET',
                        dataType: 'json',
                    },
                    "columnDefs": [

                        { "targets": 0, "data": "CommentContent1", "width": "60px" },
                        { "targets": 1, "data": "CommentQuestionID", "width": "60px" },
                        { "targets": 2, "data": "Question", "width": "200px" },
                        //{ "targets": 3, "data": "EmployeeName", "width": "60px" },
                        //{ "targets": 4, "data": "SendTime", "render": function (data) { return moment(data).format("YYYY-MM-DD HH:mm:ss") }, "width": "100px" },
                        {
                            "targets": 3, "data": "CommentQuestionID", "render": function (data) {
                                return "<a class='btn btn-warning btn-sm' onclick=PopupForm('/CommentQuestions/AddOrEdit/" + data + "')><i class='fa fa-pencil'></i> 編輯</a><a class='btn btn-danger btn-sm' style='margin-left:5px' onclick=Delete(" + data + ")><i class='fa fa-trash'></i> 刪除</a>"
                            },
                            "orderable": false,
                            "searchable": false,
                            "width": "100px"
                        }

                    ],
                    "language": {

                        "emptyTable": "目前無任何意見調查，請點選 <b>新增調查</b>"
                    }

                });


                $('#mul').multiselect({
                    buttonText: function (options, select) {
                        if (options.length == 0) {
                            return this.nonSelectedText;
                        }
                        else {
                            if (options.length - this.numberDisplayed>0) {
                                return this.nSelectedText + ' ' + (options.length-1) +" 項";
                            }
                            else if (options.length - (this.numberDisplayed+1)==0) {
                                return "已全選(7)";
                            }
                            else {
                                var selected = '';
                                options.each(function () {
                                    var label = ($(this).attr('label') !== undefined) ? $(this).attr('label') : $(this).html();

                                    selected += label + ', ';
                                });
                                return selected.substr(0, selected.length - 2) ;
                            }

                        }



                    },

                    nonSelectedText: '- - - - - - - -   請選擇   - - - - - - - -',
                    nSelectedText: '已選擇',
                    selectAllText: ' 全選',
                    includeSelectAllOption: true,
                    buttonWidth: '400px',
                    numberDisplayed: 6
                });


                 $.ajax({
                        url:'@Url.Action("LoadEmployee", "CommentQuestions")',
                        method: 'GET',
                        dataType: 'json'
                    })
                    .done(function(datas) {

                        for (var i = 0; i < datas.length; i++) {

                            $('#mul').append("<option value='" + datas[i].name + "'>" + datas[i].name+"</option>");

                            $('.multiselect-container').append("<li><a><label class='checkbox'><input type='checkbox' value='" + datas[i].name +"'>  " + datas[i].name +" </label></a></li>");

                        }

                    })

            });

            function PopupForm(url) {
                var formDiv = $('<div/>');
                $.get(url)
                    .done(function (response) {
                        formDiv.html(response);

                        Popup = formDiv.dialog({
                            autoOpen: true,
                            resizable: false,
                            title: '新增意見調查',
                            height: 700,
                            width: 1000,
                            close: function () {
                                Popup.dialog('destroy').remove();
                            }
                        });
                    });
            }

            function SubmitForm(form) {
                $.validator.unobtrusive.parse(form);
                if ($(form).valid()) {
                    $.ajax({
                        type: "POST",
                        url: form.action,
                        data: $(form).serialize(),
                        success: function (data) {
                            if (data.success) {

                                Popup.dialog("close");
                                dataTable.ajax.reload();

                                $.notify(data.message, {
                                    globalPosition: "top center",
                                    className: "success"
                                })
                            }

                        }
                    });
                }
                return false;

            }

            function Delete(id) {
                if (confirm('確定要刪除此項目嗎?')) {
                    $.ajax({
                        type: "POST",
                        url: '/CommentQuestions/Delete/' + id,
                        success: function (data) {
                            if (data.success) {

                                dataTable.ajax.reload();

                                $.notify(data.message, {
                                    globalPosition: "top center",
                                    className: "success"
                                })

                            }
                        }

                    });
                }
            }



                


            
            

            $("#CommentContent").change(function () {
                ChangeTable();
                ChangeDataTable();
            });

                function ChangeTable() {



                    $('#tableQ').empty();

                    //存下拉式選單選到的值
                    var s = $('#CommentContent').val();

                    $.ajax({
                        url: '@Url.Action("LoadQuestion", "CommentQuestions")',
                        method: 'GET',
                        dataType: 'json'
                    })
                        .done(function (datas) {
                            //<th><input type='checkbox' name='HeaderCheckbox' id='HeaderCheckbox'></th>
                            $('#tableQ').append("<tr><th><input type='checkbox' name='HeaderCheckbox' id='HeaderCheckbox'></th><th>提問編號</th><th>題目</th></tr>");
                            for (var j = 0; j < datas.length; j++) {

                                if (datas[j].CommentContentID == s) {

                                $('#tableQ').append("<tr>");
                                $('#tableQ').append("<td><input type='checkbox' class='cq' name='checkbox' value='" + datas[j].CommentQuestionID + "'></td>");
                                $('#tableQ').append("<td>" + datas[j].CommentQuestionID + "</td>");
                                $('#tableQ').append("<td>" + datas[j].Question + "</td>");
                                $('#tableQ').append("</tr>");
                                }

                                $('#HeaderCheckbox').click(function () {
                                    $('input[name="checkbox"]').prop('checked', this.checked)
                                });

                        }
                        })

                    //CheckBoxesEventHandler();

                }

            function ChangeDataTable() {
                @*var s = $('#CommentContent').val();
                $.ajax({
                    url: '@Url.Action("LoadCommentContent", "CommentQuestions")',
                    method: 'GET',
                    dataType: 'json',
                }).done(function (datas) {
                    $('#Ctable').empty();
                    $('#Ctable').append("<tr><th>提問項目</th><th>提問編號</th><th>題目</th></tr>");
                    for (var i = 0; i < datas.length; i++)
                        if (datas[i].CommentContentID == s) {
                                $('#Ctable').append("<tr>");
                                $('#Ctable').append("<td>" + datas[i].CommentContent1 + "</td>");
                                $('#Ctable').append("<td>" + datas[i].CommentQuestionID + "</td>");
                                $('#Ctable').append("<td>" + datas[i].Question + "</td>");
                                $('#Ctable').append("</tr>");
                        }
                })*@
           
                    //$("#Ctable").dataTable().fnDestroy();


                    //11if ($.fn.DataTable.isDataTable("#Ctable")) {
                    //    $('#Ctable').DataTable().destroy();
                    //}

                    //11$('#Ctable tbody').empty();

                    //$('#Ctable').DataTable({ retrieve: true, paging: false, destroy:true ,searching: false });

                    //$('#Ctable').DataTable({ paging: false, destroy: true, searching: false });


                    //$('#Ctable').DataTable({
                    //    paging: false
                    //});


                    //$('#Ctable').DataTable({
                    //    destroy: true,
                    //    searching: false
                    //});


                    @*$.ajax({
                        url: '@Url.Action("LoadCommentContent", "CommentQuestions")',
                        method: 'GET',
                        dataType: 'json'
                    })
                        .done(function (datas) {

                            var dtable = $('#Ctable tbody');
                            dtable.empty();

                            $(datas).each(function (cq) {

                                if (cq.CommentContentID == s) {

                                    dtable.append('<tr><td>' + cq.CommentContent1 + '</td><td>'
                                        + dtable.CommentQuestionID + '</td><td>' + cq.Question + '</td>');
                                }

                            }
                            );
                        });*@


                    //$("#Ctable").dataTable();
                    //}

                    //$('#Ctable').append("<tr><th>提問項目</th><th>提問編號</th><th>題目</th></tr>");
                    //    for (var j = 0; j < datas.length; j++) {

                    //        if (datas[j].CommentContentID == s) {

                    //            $('#Ctable').append("<tr>");
                    //            $('#Ctable').append("<td>" + datas[j].CommentContent1 + "</td>");
                    //            $('#Ctable').append("<td>" + datas[j].CommentQuestionID + "</td>");
                    //            $('#Ctable').append("<td>" + datas[j].Question + "</td>");
                    //            $('#Ctable').append("</tr>");

                    //        }

                    //        };

                    //}

                    //   $("#Ctable").dataTable({
                    //    "autoWidth": false,
                    //    //"destroy": true,
                    //    "info": false,
                    //    "JQueryUI": true,
                    //    "ordering": true,
                    //    "paging": false,
                    //    "scrollY": "500px",
                    //    "scrollCollapse": true
                    //});



                var DropccID = $('#CommentContent').val();

                $('#Ctable').DataTable({   
                     
                    "ajax": {
                        url: '@Url.Action("LoadCommentContent", "CommentQuestions")',
                        method: 'POST',
                        dataType: 'json',
                        data: { cid: DropccID }
                    },
                    "columnDefs": [

                        { "targets": 0, "data": "CommentContentID", "width": "60px" },
                        { "targets": 1, "data": "CommentQuestionID", "width": "60px" },
                        { "targets": 2, "data": "Question", "width": "200px" },
                        //{ "targets": 3, "data": "EmployeeName", "width": "60px" },
                        //{ "targets": 4, "data": "SendTime", "render": function (data) { return moment(data).format("YYYY-MM-DD HH:mm:ss") }, "width": "100px" },
                        {
                            "targets": 3, "data": "CommentQuestionID", "render": function (data) {
                                return "<a class='btn btn-warning btn-sm' onclick=PopupForm('/CommentQuestions/AddOrEdit/" + data + "')><i class='fa fa-pencil'></i> 編輯</a><a class='btn btn-danger btn-sm' style='margin-left:5px' onclick=Delete(" + data + ")><i class='fa fa-trash'></i> 刪除</a>"
                            },
                            "orderable": false,
                            "searchable": false,
                            "width": "100px"
                        }

                    ],
                    "language": {

                        "emptyTable": "目前無任何意見調查，請點選 <b>新增調查</b>"
                    }

                });

            }

 

                    //$('#HeaderCheckbox').click(function () {
                    //    $('input[name="checkbox"]').prop('checked', this.checked)
                    //});

                
        </script>

    }
</body>
</html>
